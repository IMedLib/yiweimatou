{% extends '../layout/header.html'%}
{% block css%}
<link rel="stylesheet" href="/css/lib/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="/css/lib/sky-forms.css">
<link rel="stylesheet" href="/css/lib/custom-sky-forms.css">
<link rel="stylesheet" href="/css/lib/jqpagination.css">
{% endblock %}
{% block breadcrumbs %}
<li><a href="/index">首页</a></li>
<li><a href="/lesson/show?lid={{lesson.lid}}">{{lesson.title}}</a></li>
<li class="active">{{clazz.title}}</li>
{% endblock %}

{% block body %}
<div class="row">
    <div class="col-sm-3">
        <ul class="list-group sidebar-nav-v1">
            <li class="list-group-item list-toggle active">
                <a href="#collapse-clazz" data-toggle="collapse"><i class="fa fa-edit"></i>&nbsp;编辑课堂</a>
                <ul class="collapse in" id="collapse-clazz">
                    <li class="active">
                        <a href="#info" data-toggle="tab">修改信息</a>

                    </li>
                    <li><a href="#cover" data-toggle="tab">更换封面</a></li>

                </ul>
            </li>
            <li class="list-group-item list-toggle">
                <a href="#collapse-file" data-toggle="collapse" class="accordion-toggle">
                    <i class="fa fa-files-o"></i>&nbsp;资源管理
                </a>
                <ul class="collapse" id="collapse-file">
                    <li><a href="#addClazzFiles" data-toggle="tab">新增资源</a></li>
                    <li>
                        <a href="#delFiles" data-toggle="tab">删除资源</a>
                    </li>
                </ul>
            <li class="list-group-item list-toggle">
                <a href="#collapse-yunbook" data-toggle="collapse" class="accordion-toggle">
                    <i class="fa fa-book"></i>&nbsp;云板书管理
                </a>
                <ul class="collapse" id="collapse-yunbook">
                    <li><a href="#addYunbook" data-toggle="tab">新增云板书</a></li>
                    <li>
                        <a href="#yunbook" data-toggle="tab">管理云板书</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="col-sm-9">
        <div class="tab-content">
            <div id="info" class="profile-edit tab-pane fade in active">
                <form class="sky-form">
                    <fieldset>
                        <section>
                            <label class="label" for="title">名称</label>
                            <label class="input">
                                <input type="text" required="required" value="{{clazz.title}}" id="title">
                            </label>
                        </section>
                        <div class="row">
                            <section class="col col-6">
                                <label class="input">
                                    <i class="icon-append fa fa-calendar"></i>
                                    <input class="ui-datepicker" required type="text" id="start"
                                           value="{{clazz.starttime}}">
                                </label>
                            </section>
                            <section class="col col-6">
                                <label class="input">
                                    <i class="icon-append fa fa-calendar"></i>
                                    <input class="ui-datepicker" required
                                           type="text" id="end" value="{{clazz.endtime}}">
                                </label>
                            </section>
                        </div>
                        <section>
                            <label class="label" for="remark">简介</label>
                            <label class="textarea">
                                <textarea rows="3" id="remark">{{clazz.remark}}</textarea>
                            </label>
                        </section>
                    </fieldset>
                    <footer>
                        <button type="submit" class="btn-u pull-right">修改</button>
                    </footer>
                </form>
            </div>
            <div id="cover" class="tab-pane fade">
                <div class="row">
                    <img src="{{clazz.coverpath}}1024_512.png" class="img-responsive center-block" id="image"
                         alt="封面图片">
                </div>

                <div class="row margin-top-20">
                    <div class="btn-group pull-right">
                        <label title="Upload image file" for="inputImage" class="btn-u btn-lg btn-link">
                            <input type="file" accept="image/*" name="file" id="inputImage" class="hide">
                            上传新封面
                        </label>
                        <label id="submit" class="btn-u btn-lg btn-link">确认提交</label>
                    </div>
                </div>
            </div>
            <div id="yunbook" class="tab-pane fade in">
                <div class="row" id="yunbookEdit"></div>
            </div>
            <div id="addYunbook" class="tab-pane fade in">
                <span class="color-red" hidden id="err2"></span>
                <span id="message2" class="color-green" hidden></span>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <tbody id="yunbooks"></tbody>
                    </table>
                </div>
                <div class="pagination" hidden id="yunbookPage">
                    <a href="#" class="first" data-action="first">&laquo;</a>
                    <a href="#" class="previous" data-action="previous">&lsaquo;</a>
                    <input title="" type="text" readonly="readonly"/>
                    <a href="#" class="next" data-action="next">&rsaquo;</a>
                    <a href="#" class="last" data-action="last">&raquo;</a>
                </div>
                <button type="button" id="addYunbookSubmit" class="btn-u pull-right">
                    添加
                </button>
            </div>
            <div id="delFiles" class="tab-pane fade in">
                <div id="files" class="row"></div>
                <div class="pagination fade" id="filep">
                    <a href="#" class="first" data-action="first">&laquo;</a>
                    <a href="#" class="previous" data-action="previous">&lsaquo;</a>
                    <input title="" type="text" readonly="readonly"/>
                    <a href="#" class="next" data-action="next">&rsaquo;</a>
                    <a href="#" class="last" data-action="last">&raquo;</a>
                </div>
            </div>
            <div id="addClazzFiles" class="tab-pane fade in">
                <span class="color-red" hidden id="err"></span>
                <span id="message" class="color-green" hidden></span>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <tbody id="fileList"></tbody>
                    </table>
                </div>
                <div class="pagination" hidden id="addFilep">
                    <a href="#" class="first" data-action="first">&laquo;</a>
                    <a href="#" class="previous" data-action="previous">&lsaquo;</a>
                    <input title="" type="text" readonly="readonly"/>
                    <a href="#" class="next" data-action="next">&rsaquo;</a>
                    <a href="#" class="last" data-action="last">&raquo;</a>
                </div>
                <button type="button" id="addFileSubmit" class="btn-u pull-right">
                    添加
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="/js/lib/bootstrap-datetimepicker.min.js"></script>
<script src="/js/lib/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="/js/lib/jquery.jqpagination.min.js"></script>
<script src="/js/lib/template.js"></script>
<script type="text/javascript" src="/js/lib/jquery.blockUI.js"></script>
<script type="text/html" id="yunbookTemplate">
    [each list as yunbook]
    <tr>
        <td><input type="radio" name="toAddYunbook" value="[yunbook.yid]"></td>
        <td class="contact-type"><i class="fa fa-file"> </i></td>
        <td>[yunbook.title]</td>
    </tr>
    [/each]
</script>
<script type="text/html" id="addFiles">
    [each list as file]
    <tr>
        <td><input type="checkbox" value="[file.fid]"></td>
        <td>[file.title]</td>
    </tr>
    [/each]
</script>
<script type="text/html" id="listFiles">
    [each list as file]
    <div class="col-sm-4">
        <div class="file" id="[file.id]">
            <a href="javascript:fileDel([file.id])" class="pull-right color-red"><i class="fa fa-close"></i></a>
            <a href="#">
                <span class="corner"></span>
                <div class="icon">
                    <i class="fa fa-file"></i>
                </div>
                <div class="file-name">
                    [file.title]
                </div>
            </a>
        </div>
    </div>
    [/each]
</script>
<script>
    $(document).ready(function () {
        var $inputImage = $("#inputImage"), $image = $('#image'), limit = 9
                , $error = $('#err'), $message = $('#message'), $error2 = $('#err2')
                , $message2 = $('#message2');
        template.config('openTag', '[');
        template.config('closeTag', ']');
        $('.ui-datepicker').datetimepicker({
            language: 'zh-CN',
            format: 'yyyy-mm-dd hh:ii:ss',
            weekStart: 1,
            todayBtn: 1,
            autoclose: 1,
            todayHighlight: 1,
            startView: 2,
            forceParse: 0,
            showMeridian: 1
        });
        jQuery('.accordion-toggle').on('click', function () {
            jQuery(this).parent().toggleClass('active');
        });
        $(document).on('click', 'ul.collapse.in>li>a', function () {
            var active = $('ul.collapse>li.active').not($(this).parent());
            if (typeof active === 'undefined') return;
            active.removeClass('active');
        });
        $('a[href="#addYunbook"]').on('click', function () {
            var $yunbooks = $('#yunbooks')
                    , $yunbookPage = $('#yunbookPage');
            if ($yunbooks.html() === '') {
                var count = getYunbookCount();
                getYunbooks(limit, 1);
                $yunbookPage.jqPagination({
                    max_page: Math.ceil(count / limit),
                    page_string: '第{current_page}页,共{max_page}页',
                    paged: function (page) {
                        getYunbooks(limit, page);
                    }
                });
                $yunbookPage.show();
            }
        });
        $('#addFileSubmit').on('click', function () {
            var checked = $(':checkbox:checked');
            checked.each(function () {
                postAdd({
                    fid: this.value,
                    title: $(this).parent().parent().children().last().html()
                });
            });
        });
        $('#addYunbookSubmit').on('click', function () {
            var checked = $(':radio:checked').eq(0);
            $.ajax({
                url: '{{config.url.api}}yunbook/add',
                type:'post',
                data: {
                    cid: '{{clazz.cid}}',
                    yid: checked.val(),
                    title: checked.parent().parent().children().last().html(),
                    zoom: 4,
                    point: 'POINT(0 0)',
                    key: '{{key}}',
                    token: '{{token}}'
                }
            }).done(function (data) {
                if (data.code === 0) {
                    $message2.html('添加云板书成功！').show().fadeOut(5000);
                } else {
                    $error2.html(data.msg).show().fadeOut(5000);
                }
            }).fail(function () {
                $error2.html('添加云板书超时').show().fadeOut(5000);
            });
        });
        function postAdd(file) {
            $.block();
            $.ajax({
                url: '{{config.url.api}}file/add',
                type:'post',
                data: {
                    key: '{{key}}',
                    token: '{{token}}',
                    cid: '{{clazz.cid}}',
                    fid: file.fid,
                    title: file.title,
                    zoom: 4,
                    point: 'POINT(0 0)'
                }
            }).done(function (data) {
                if (data.code === 0) {
                    $message.html(file.title + '添加到{{clazz.title}}').show().fadeOut(5000);
                } else {
                    $error.html(file.title + data.msg === '' ? '添加失败!' : data.msg)
                            .show().fadeOut(5000);
                }
            }).fail(function () {
                $error.html(file.title + '操作超时').show().fadeOut(5000);
            }).always(function(){
                $.unblock();
            });
        }

        function getYunbookCount() {
            var count = 0;
            $.ajax({
                url: "{{config.url.api}}useryunbook/info",
                async: false
            }).done(function (data) {
                if (data.code === 0) {
                    count = data.info.Count;
                } else {
                    $error2.html(data.msg).show().fadeOut(5000);
                }
            }).fail(function () {
                $error2.html('获取云板书信息超时').show().fadeOut(5000);
            });
            return count;
        }

        function getYunbooks(limit, offset) {
            $.ajax({
                url: "{{config.url.api}}useryunbook/list",
                data: {
                    limit: limit,
                    offset: offset
                }
            }).done(function (data) {
                if (data.code === 0) {
                    $('#yunbooks').html(template('yunbookTemplate', data));
                } else {
                    $error2.html(data.msg).show().fadeOut(5000);
                }
            }).fail(function () {
                $error2.html('获取云板书列表超时').show().fadeOut(5000);
            });
        }

        $('a[href="#addClazzFiles"]').on('show.bs.tab', function () {
            var $fileList = $('#fileList');
            if ($fileList.html() === '') {
                var count = getUserFileCounts(), $up = $('#addFilep');
                if (count > 0) {
                    getUserFiles($fileList, limit, 1);
                    $up.jqPagination({
                        max_page: Math.ceil(count / limit),
                        page_string: '第{current_page}页,共{max_page}页',
                        paged: function (page) {
                            getUserFiles($fileList, limit, page);
                        }
                    });
                    $up.show();
                }
            }
        });
        $('a[href="#delFiles"]').on('show.bs.tab', function () {
            var $files = $('#files');
            if ($files.html() === '') {
                var count = getFileCounts('{{clazz.cid}}'), $filep = $('#filep');
                console.log(count);
                if (count > 0) {
                    getFiles($files, limit, 1);
                    $filep.jqPagination({
                        max_page: Math.ceil(count / limit),
                        page_string: '第{current_page}页,共{max_page}页',
                        paged: function (page) {
                            getFiles($files, limit, page);
                        }
                    });
                    $filep.removeClass('fade');
                }
            }
        });
        $('a[href="#yunbook"]').on('show.bs.tab', function () {
            if($('#yunbook').find('div').html() === ''){
                $.ajax({
                    url: '{{config.url.api}}yunbook/get',
                    data: {
                        cid: '{{clazz.cid}}'
                    }
                }).done(function (data) {
                    var $yunbookEdit = $('#yunbookEdit');
                    if (data.get.id !== undefined) {
                        $yunbookEdit.html('<div class="col-sm-3 file"><a href="javascript:yunbookDel(' + data.get.id +
                                ')" class="pull-right color-red"><i class="fa fa-close"></i></a>'
                                + '<div class="icon">'
                                + '<i class="fa fa-book"></i>'
                                + '</div>'
                                + '<div class="file-name">'
                                +'<a href="/yunbook/show?yid=' + data.get.yid + '">'
                                + data.get.title+'</a><a class="pull-right" href="/yunbook/edit?id='+data.get.id+'">编辑</a>'
                                + '</div></div>');
                    }
                });
            }
        });
        function getUserFileCounts() {
            var count = 0;
            $.ajax({
                url: '{{config.url.api}}userFile/info',
                async: false
            }).done(function (data) {
                if (data.code === 0) {
                    count = data.info.Count;
                } else {
                    alert(data.msg === '' ? '获取文件数失败！' : data.msg);
                }
            }).fail(function () {
                alert('请求超时!');
            });
            return count;
        }

        function getUserFiles(object, limit, offset) {
            $.ajax({
                url: '{{config.url.api}}userFile/list',
                data: {
                    limit: limit,
                    offset: offset
                }
            }).done(function (data) {
                if (data.code === 0) {
                    object.html(template('addFiles', data));
                } else {
                    alert(data.msg === '' ? '获取文件失败！' : data.msg);
                }
            }).fail(function () {
                alert('请求超时，请稍后再试!');
            });
        }

        function getFileCounts(cid) {
            var count = 0;
            $.ajax({
                url: '{{config.url.api}}/file/info',
                data: {
                    cid: cid
                },
                async: false
            }).done(function (data) {
                if (data.code === 0) {
                    count = data.info.Count;
                } else {
                    alert(data.msg === '' ? '获取文件数失败！' : data.msg);
                }
            }).fail(function () {
                alert('请求超时!');
            });
            return count;
        }

        function getFiles(object, limit, offset) {
            $.ajax({
                url: '{{config.url.api}}file/list',
                data: {
                    cid: '{{clazz.cid}}',
                    limit: limit,
                    offset: offset
                }
            }).done(function (data) {
                if (data.code === 0) {
                    object.html(template('listFiles', data));
                } else {
                    alert(data.msg === '' ? '获取文件失败！' : data.msg);
                }
            }).fail(function () {
                alert('请求超时，请稍后再试!');
            });
        }

        if (window.FileReader) {
            $inputImage.change(function () {
                var fileReader = new FileReader(),
                        files = this.files,
                        file;
                if (!files.length) {
                    return;
                }
                file = files[0];

                if (/^image\/\w+$/.test(file.type)) {
                    fileReader.readAsDataURL(file);
                    fileReader.onload = function () {
                        $image.attr('src', this.result);
                    };
                } else {
                    alert("请选择图片!");
                }
            });
        } else {
            $inputImage.addClass("hide");
        }
        $('#submit').on('click', function () {
            var uploadfile = $inputImage.get(0).files[0];
            if (typeof uploadfile === 'undefined') {
                alert('请选择一张图片');
                return false;
            }
            var formData = new FormData();
            formData.append('uploadfile', uploadfile);
            $.block();
            $.ajax({
                url: '{{config.url.upload}}/file',
                data: formData,
                processData: false,
                contentType: false,
                type: 'POST',
                timeout: 300000
            }).done(function (data) {
                if (data.code === 0) {
                    $.ajax({
                        url: '{{config.url.api}}/classroom/put',
                        type:'post',
                        data: {
                            cid: '{{clazz.cid}}',
                            coverpath: '{{config.url.domain}}cover/' + data.cover_path,
                            key: '{{key}}',
                            token: '{{token}}'
                        }
                    }).done(function (data) {
                        if (data.code === 0) {
                            alert('更新封面成功！');
                        } else {
                            alert(data.msg === '' ? '更换封面失败！' : data.msg);
                        }
                    }).fail(function () {
                        alert('更换封面失败！');
                    });
                } else {
                    alert(data.msg === '' ? '上传失败，请稍后再试！' : data.msg);
                }
            }).fail(function () {
                alert('上传超时，请稍后再试！');
            }).always(function(){
                $.unblock();
            });
        });
        $('form').submit(function (e) {
            e.preventDefault();
            $('form').block();
            $.ajax({
                url: '{{config.url.api}}classroom/put',
                type:'post',
                data: {
                    cid: '{{clazz.cid}}',
                    starttime: $('#start').val(),
                    endtime: $('#end').val(),
                    title: $('#title').val(),
                    remark: $('#remark').val(),
                    key: "{{key}}",
                    token: "{{token}}"
                }
            }).done(function (data) {
                if (data.code === 0) {
                    alert('修改成功！');
                } else {
                    alert(data.msg === '' ? '修改失败！' : data.msg);
                }
            }).fail(function () {
                alert('修改超时，请重新提交！');
            }).always(function(){
                $('form').unblock();
            });
            return false;
        });
    });
    function fileDel(id) {
        if (typeof id === 'undefined') {
            return;
        }
        $.ajax({
            url: '{{config.url.api}}file/del',
            type:'post',
            data: {
                id: id,
                key: '{{key}}',
                token: '{{token}}'
            }
        }).done(function (data) {
            if (data.code === 0) {
                var node = document.getElementById(id);
                node.parentNode.removeChild(node);
                alert('删除成功！');
            } else {
                alert(data.msg === '' ? '删除失败！' : data.msg);
            }
        }).fail(function () {
            alert('删除失败！');
        });
    }
    function yunbookDel(id) {
        if (typeof id === 'undefined') {
            return;
        }
        $.ajax({
            url: '{{config.url.api}}yunbook/del',
            type:'post',
            data: {
                id: id,
                key: "{{key}}",
                token: '{{token}}'
            }
        }).done(function (data) {
            if (data.code === 0) {
                $('#yunbookEdit').empty();
                alert('删除成功！');
            } else {
                alert(data.msg === '' ? '删除失败！' : data.msg);
            }
        }).fail(function () {
            alert('删除失败！');
        });

    }
</script>
{% endblock %}